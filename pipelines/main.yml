pr:
  - main
trigger:
  batch: "true"
  branches:
    include: 
      - '*'
  tags:
    include:
    - '*'
  paths:
    exclude: 
      - '_test-agent/*'
      - '.vscode/*'
      - '.devcontainer/*'

parameters:
  - name: tags
    type: string
    default: "1.0.5,0.7.11"

resources: 
  repositories:
    - repository: repo_1_0_5
      type: github
      endpoint: "azure-pipelines-terraform-rc (1)"
      name: jason-johnson/azure-pipelines-tasks-terraform
      ref: refs/tags/${{ split(parameters.tags, ',')[0] }}
    - repository: repo_0_7_11
      type: github
      endpoint: "azure-pipelines-terraform-rc (1)"
      name: jason-johnson/azure-pipelines-tasks-terraform
      ref: refs/tags/${{ split(parameters.tags, ',')[1] }}
  
variables:
  Agent.Source.Git.ShallowFetchDepth: 0
  tf_variables_secure_file: 4a0c36e2-bb51-41ed-87b1-2e668c64bb69
  marketplace_publisher: JasonBJohnson
  ado_service_url: https://dev.azure.com/azure-pipelines-terraform-rc

pool:
  vmImage: ubuntu-latest

name: $(GitVersion.FullSemVer)

stages:
- stage: setup
  variables:
    - group: build
  jobs:
  - job: version
    steps:
    - task: gitversion/setup@0
      displayName: install GitVersion
      inputs:
        versionSpec: '5.x'
    - task: gitversion/execute@0
      displayName: set version
      name: version
  - job: tags
    steps:
    - script: scripts/max_tags.sh
      name: tags

- stage: build
  dependsOn: setup
  variables:
    - name: GitVersion.SemVer
      value: $[ stageDependencies.setup.version.outputs['version.GitVersion.SemVer'] ]
    - name: GitVersion.Major
      value: $[ stageDependencies.setup.version.outputs['version.GitVersion.Major'] ]
    - name: GitVersion.Minor
      value: $[ stageDependencies.setup.version.outputs['version.GitVersion.Minor'] ]
    - name: GitVersion.Patch
      value: $[ stageDependencies.setup.version.outputs['version.GitVersion.Patch'] ]
    - group: build
  jobs:
  - template: templates/build_tasks.yml
    parameters:
      instance: main

  - ${{ each tag in split(parameters.tags, ',')}}:
    - template: templates/build_tasks.yml
      parameters:
        checkout: repo_${{ replace(tag, '.', '_') }}
        instance: ${{ replace(tag, '.', '_') }}

  - job: terraform_plan
    steps:
      - template: templates/build_npm.yml
        parameters:
          workingDir: $(System.DefaultWorkingDirectory)/views/terraform-plan
          artifact: terraform_plan

      # Unfortunately, terraform plan view needs some work to have it complay with test_npm.yml so we hard code the steps for now
      - task: Npm@1
        displayName: test
        inputs:
          workingDir: $(System.DefaultWorkingDirectory)/views/terraform-plan
          command: custom
          customCommand: run test
      - task: PublishTestResults@2
        displayName: test - publish results
        inputs:
          testResultsFormat: JUnit
          testResultsFiles: 'results.xml'
          searchFolder: $(System.DefaultWorkingDirectory)/views/terraform-plan/.tests

  - job: terraform_templates
    steps:
      - task: CopyFiles@2
        displayName: terraform templates
        inputs:
          contents: |   
            templates/**/*
          targetFolder: $(Build.ArtifactStagingDirectory)/terraform_templates
      - task: PublishBuildArtifacts@1
        inputs:
          pathToPublish: '$(Build.ArtifactStagingDirectory)/terraform_templates'
          artifactName: terraform_templates

  - job: terraform_extension
    steps:
      - task: Npm@1
        displayName: version
        inputs:
          workingDir: $(System.DefaultWorkingDirectory)
          command: custom
          customCommand: version $(GitVersion.SemVer) --no-git-tag-version --allow-same-version
      - task: Npm@1
        displayName: install
        inputs:
          workingDir: $(System.DefaultWorkingDirectory)
          command: ci
      - task: CopyFiles@2
        displayName: stage extension
        inputs:
          contents: |
            !node_modules/.bin/*
            screenshots/*
            overview.md
            package*.json
            vss-extension*.json
            vss-extension-icon.png
            **/poll_task_install.sh
          targetFolder: $(Build.ArtifactStagingDirectory)/terraform_extension
      - task: PublishBuildArtifacts@1
        inputs:
          pathToPublish: '$(Build.ArtifactStagingDirectory)/terraform_extension'
          artifactName: terraform_extension

- stage: publish
  dependsOn:
    - setup
    - build
  variables:
    - group: env_rc
  jobs:
  - deployment: publish_private_rc
    displayName: publish private rc
    environment: marketplace_rc
    variables:
        - name: GitVersion.SemVer
          value: $[ stageDependencies.setup.version.outputs['version.GitVersion.SemVer'] ]
        - name: GitVersion.Major
          value: $[ stageDependencies.setup.version.outputs['version.GitVersion.Major'] ]
        - name: GitVersion.Minor
          value: $[ stageDependencies.setup.version.outputs['version.GitVersion.Minor'] ]
        - name: GitVersion.Patch
          value: $[ stageDependencies.setup.version.outputs['version.GitVersion.Patch'] ]
        - name: GitVersion.CommitsSinceVersionSource
          value: $[ stageDependencies.setup.version.outputs['version.GitVersion.CommitsSinceVersionSource'] ]
    strategy:
      runOnce:
        deploy:
          steps:    
          - task: DownloadPipelineArtifact@2
            displayName: download terraform extension
            inputs: 
              artifact: terraform_extension
              path: $(System.DefaultWorkingDirectory)
          - task: DownloadPipelineArtifact@2
            displayName: download terraform_installer@2
            inputs: 
              artifact: terraform_installer_main
              path: $(System.DefaultWorkingDirectory)/tasks/terraform-installer/v2
          - task: DownloadPipelineArtifact@2
            displayName: download terraform_cli@2
            inputs:
              artifact: terraform_cli_main
              path: $(System.DefaultWorkingDirectory)/tasks/terraform-cli/v2
          - task: DownloadPipelineArtifact@2
            displayName: download views terraform plan
            inputs:
              artifact: terraform_plan
              path: $(System.DefaultWorkingDirectory)/views/terraform-plan
          - ${{ each tag in split(parameters.tags, ',')}}:
            - task: DownloadPipelineArtifact@2
              displayName: download terraform_installer@${{ split(tag, '.')[0] }}
              inputs: 
                artifact: terraform_installer_${{ replace(tag, '.', '_') }}
                path: $(System.DefaultWorkingDirectory)/tasks/terraform-installer/v${{ split(tag, '.')[0] }}
            - task: DownloadPipelineArtifact@2
              displayName: download terraform_cli@${{ split(tag, '.')[0] }}
              inputs: 
                artifact: terraform_cli_${{ replace(tag, '.', '_') }}
                path: $(System.DefaultWorkingDirectory)/tasks/terraform-cli/v${{ split(tag, '.')[0] }}

          # TODO: Remove this
          - bash: echo "$(GitVersion.Major).$(GitVersion.Minor).$(GitVersion.Patch).$(GitVersion.CommitsSinceVersionSource)"
            displayName: show version string

          - task: TfxInstaller@3
            displayName: 'install tfx-cli'
            inputs:
              version: '0.8.x'
              checkLatest: true
          - bash: tfx extension unpublish 
              --publisher $(marketplace_publisher) 
              --extension-id azure-pipelines-tasks-terraform-rc
              -t $(marketplace_access_token)
            displayName: unpublish extension
          - task: PublishAzureDevOpsExtension@4
            name: publish
            inputs:
              connectedServiceName: 'marketplace_jasonbjohnson'
              rootFolder: $(System.DefaultWorkingDirectory)
              patternManifest: |
               vss-extension.json
               vss-extension-rc.json
              extensionVersion: $(GitVersion.Major).$(GitVersion.Minor).$(GitVersion.Patch).$(GitVersion.CommitsSinceVersionSource)
              shareWith: $(marketplace_share_with)
          - task: InstallAzureDevOpsExtension@4
            displayName: 'Install Extension'
            inputs:
              connectedServiceName: 'marketplace_jasonbjohnson'
              publisherId: $(marketplace_publisher)
              extensionId: azure-pipelines-tasks-terraform-rc
              accounts: $(ado_service_url)
          - task: Bash@3
            name: wait_tasks_terraform_installer
            inputs:
              filePath: $(Build.SourcesDirectory)/pipelines/publish/poll_task_install.sh
              arguments: -s $(ado_service_url) -t $(organization_access_token) -c 2b4600b9-5cd9-4e3b-9c8b-553c8e58383a          
          - task: Bash@3
            name: wait_tasks_terraform_cli
            inputs:
              filePath: $(Build.SourcesDirectory)/pipelines/publish/poll_task_install.sh
              arguments: -s $(ado_service_url) -t $(organization_access_token) -c 51355d76-dd54-4754-919d-bba27fdf59e4
